<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Home</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}">
</head>
<body>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for message in messages %}
        <p class="flash">{{ message }}</p>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <h1>Hello {{ user.user_name if user.user_name else user.first_name }}</h1>

  <div class="top-actions">
    <a href="{{ url_for('create') }}" class="create-quote-btn">+ Share a Quote</a>

    <form action="{{ url_for('logout') }}" method="get">
      <button type="submit">Logout</button>
    </form>
  </div>

  {% if quotes %}
  <h3>All Quotes</h3>

  <div class="quotes-grid">
    {% for q in quotes %}
    <div class="quote-card">

      <!-- Author + date -->
      <div class="quote-header">
        <span class="author">{{ q.author_name }}</span>
        <span class="date">
          {% if q.post_date %}
            {% if q.post_date.__class__.__name__ in ['date','datetime'] %}
              {{ q.post_date.strftime('%m/%d/%Y') }}
            {% else %}
              {{ q.post_date.split(' ')[0].replace('-', '/') }}
            {% endif %}
          {% endif %}
          {% if session['edited_quotes'] and q.id in session['edited_quotes'] %}
            <span class="edited">(edited)</span>
          {% endif %}
        </span>
      </div>

      <!-- Quote -->
      <div class="quote-text">&quot;{{ q.qoute }}&quot;</div>

      <!-- Actions -->
      <div class="quote-actions">

        <!-- Social -->
        <div class="quote-social">
          <form action="{{ url_for('like_quote', quote_id=q.id) }}" method="POST">
            <button class="icon-btn" type="submit">
              {% if q.id|string in session.get('liked_quotes', []) %}ğŸ‘{% else %}ğŸ‘{% endif %}
            </button>
            <span class="count like">{{ q.likes or 0 }}</span>
          </form>

          <form action="{{ url_for('dislike_quote', quote_id=q.id) }}" method="POST">
            <button class="icon-btn" type="submit">
              {% if q.id|string in session.get('disliked_quotes', []) %}ğŸ‘{% else %}ğŸ‘{% endif %}
            </button>
            <span class="count dislike">{{ q.dislikes or 0 }}</span>
          </form>

          {% if q.users_id %}
          <button class="icon-btn" type="button" onclick="toggleForm({{ q.id }})">ğŸ’¬</button>
          {% endif %}
        </div>

        <!-- Owner -->
        {% if q.users_id == user.id %}
        <div class="quote-owner-actions">
          <form action="{{ url_for('update_quote', users_id=q.id) }}" method="GET">
            <button class="text-btn">Edit</button>
          </form>
          <form action="{{ url_for('delete_quote_by_id', quote_id=q.id) }}" method="POST">
            <button class="text-btn danger"
              onclick="return confirm('Delete this quote?')">
              Delete
            </button>
          </form>
        </div>
        {% endif %}
      </div>

      <!-- Comment box -->
      {% if q.users_id %}
      <div id="comment-{{ q.id }}" class="comment-box">
        <form action="{{ url_for('add_comment', quote_id=q.id) }}" method="POST">
          <textarea name="comment_text" rows="3" placeholder="Write a comment..."></textarea>
          <input type="submit" value="Post Comment">
        </form>
      </div>
      {% endif %}

      <!-- Comments -->
      {% if q.comments %}
      <ul class="comments">
        {% for c in q.comments %}
        <li>
          <div class="comment-meta">
            <strong>{{ c.author }}</strong>
            {% if c.date %}<span>{{ c.date }}</span>{% endif %}
            {% if c.edited %}<em>(edited)</em>{% endif %}
          </div>

          <div class="comment-text">{{ c.text }}</div>

          <!-- Like/Dislike for comments -->
          <div class="comment-social">
            <form action="{{ url_for('like_comment', quote_id=q.id, comment_idx=loop.index0) }}" method="POST" style="display:inline;">
              {% set liked_comments = session.get('liked_comments', []) %}
              <button type="submit" class="icon-btn">
                {% set comment_key = q.id|string ~ ':' ~ loop.index0 %}
                {% if comment_key in liked_comments %}ğŸ‘{% else %}ğŸ‘{% endif %}
              </button>
              <span class="count like">{{ c.likes if c.likes is defined else 0 }}</span>
            </form>
            <form action="{{ url_for('dislike_comment', quote_id=q.id, comment_idx=loop.index0) }}" method="POST" style="display:inline;">
              {% set disliked_comments = session.get('disliked_comments', []) %}
              <button type="submit" class="icon-btn">
                {% if comment_key in disliked_comments %}ğŸ‘{% else %}ğŸ‘{% endif %}
              </button>
              <span class="count dislike">{{ c.dislikes if c.dislikes is defined else 0 }}</span>
            </form>
          </div>

          {% if c.author == (user.user_name if user.user_name else user.first_name) %}
          <div class="comment-actions">
            <form action="{{ url_for('delete_comment', quote_id=q.id, comment_idx=loop.index0) }}" method="POST">
              <button class="text-btn danger">Delete</button>
            </form>
            <form action="{{ url_for('edit_comment', quote_id=q.id, comment_idx=loop.index0) }}" method="GET">
              <button class="text-btn">Edit</button>
            </form>
          </div>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% endif %}

    </div>
    {% endfor %}
  </div>
  {% endif %}

  <script>
    function toggleForm(id) {
      const el = document.getElementById('comment-' + id);
      if (!el) return;
      el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }
  </script>

</body>
</html>
